<!DOCTYPE html>
<html>
  <head>
    <title>JavaScript file upload</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">



    <script src="https://wzrd.in/standalone/buffer"></script><!-- for the buffer -->
    <script src="https://unpkg.com/ipfs-api@9.0.0/dist/index.js"
    integrity="sha384-5bXRcW9kyxxnSMbOoHzraqa7Z0PQWIao+cgeg327zit1hz5LZCEbIMx/LWKPReuB"
    crossorigin="anonymous"></script><!-- for the ipfs Interface -->
    <script type="text/javascript" src="js/web3.js"></script>
    <script type="text/javascript" src="js/ethjs.js"></script>
    <script type="text/javascript" src="js/BN.js"></script>

    <script type= "text/javascript" src="js/IPFSContractABI.js"></script>
    <script type= "text/javascript" src="js/ETHCommon.js"></script>


  </head>
  <script type="text/javascript">
  function makeDeed(id)
  {
    // mint(  uint256 _id ,string ipfsAddress) payable external
    var ipfshash = document.getElementById("url").innerHTML;
    var accaddress = GetAccountAddress();
    var contract = EthereumConnection.GetContract("IPFS");


    var EthinWei = 1000000000000000000; // This is 1 ETH
    var price = 0.01*EthinWei;
    var bn = new BN(id,10);


    contract.mint(id,ipfshash, {from: accaddress, value: price,  gas: 1000000},function(err, res){
      if (err)
      {
        console.log('Failed to mint, because:' + String(err));
      }
      else
      {
        console.log('Minted' + String(res));
      }
    });
  }
    function upload()
    {
      const reader = new FileReader();
      reader.onloadend = function() {
        const ipfs = window.IpfsApi('localhost', 5001) // Connect to IPFS
        const buf = buffer.Buffer(reader.result) // Convert data into buffer
        ipfs.files.add(buf, (err, result) => { // Upload buffer to IPFS
          if(err)
          {
            console.error(err)
            consoleLog("**IPFS** not available: " + err);
            return
          }
          let url = `https://ipfs.io/ipfs/${result[0].hash}`
          let ipfsaddess = result[0].hash;
          console.log(`Url --> ${url}`)
          document.getElementById("ipfsAddress").value= ipfsaddess;
          document.getElementById("output").src = url;
          document.getElementById("url").innerHTML= url
          document.getElementById("url").href= url
          document.getElementById("output").src = url
        })
      }
      const photo = document.getElementById("photo");
      reader.readAsArrayBuffer(photo.files[0]); // Read Provided File
    }
  </script>

<script>
function myTest()
{

  var contract = EthereumConnection.GetContract("IPFS");
  contract.GetMintPrice(function(err, res){
    if (err)
    {
        document.getElementById("testbutton").innerHTML = "Not Connected to Ethereum Error!";
    }
    else
    {
      price = Number(res[0]);
      if (price == 10000000000000000)
        document.getElementById("testbutton").innerHTML = "OK!";
        else {
          document.getElementById("testbutton").innerHTML = "C Error!";
        }
    }
  });
}
</script>

  <body>

    <form action="/">
      <fieldset>
        <legend>System Info</legend>
        <button type="button" id="testbutton" onclick="myTest()">Test!</button>
        <div id="sysinfo">
      </div>
      </fieldset>

    <script>
    var myDeedCount = 0;
    var myDeeds = [];
    function whoami()
    {
      return GetAccountAddress();
    }
    function GetDeedCount()
    {
      /// --
      var accaddress = GetAccountAddress();
      var contract = EthereumConnection.GetContract("IPFS");
      contract.balanceOf(accaddress,function(err, res){
        if (err)
        {
          consoleLog("**[Error] Ethereum Contract**" + String(err));
          console.log('error' + String(err));
        }
        else
        {
          var value = res[0];
          myDeedCount =value.toNumber();
          consoleLog('You have ' + value.toString() + " Deed/s");
          UpdateDeedTable();
        }
      });
    }
  function UpdateDeedTable()
  {
    myDeeds = [];
    if (myDeedCount >0)
    {
      for (var i = 0; i <myDeedCount-1; i++)
        putDeedInTable(i,false);
      putDeedInTable(i,true);
    }
  }

  function GetIPFSData(count,id)
  {
    var contract = EthereumConnection.GetContract("IPFS");
    var accaddress = GetAccountAddress();
    contract.GetIPFSAddress( id,function(err, res){
      if (err)
      {
        consoleLog("** [Error] GetIPFSFromToken ** " + String(err));
      }
      else
      {
        myDeeds.push({index: count, value:  String(id), ipfs: String(res[0])});
        renderDeedTable();
      }
    });

  }

  function renderDeedTable()
  {
    var html = "<table border='1|1'>";
    html+="<tr>";
    html+="<td>"+"Index"+"</td>";
    html+="<td>"+"Token ID"+"</td>";
    html+="<td>"+"IPFs Link"+"</td>";
    html+="</tr>";

    // loop through the deeds.
    for (var i = 0; i <myDeeds.length; i++)
    {
      var elem = myDeeds[i];
      var num = elem.index;
      var ipfs = elem.ipfs;
      html+="<tr>";
      html+="<td>"+num.toString();+"</td>";
      html+="<td>"+elem.value+"</td>";
      html+="<td>"+ipfs+"</td>";
      html+="</tr>";

    }
    html+="</table>";
    document.getElementById("deedbox").innerHTML = html;

  }
  function putDeedInTable(id, last)
  {
    var contract = EthereumConnection.GetContract("IPFS");
    var accaddress = GetAccountAddress();
    contract.tokenOfOwnerByIndex(accaddress, id,function(err, res){
      if (err)
      {
        consoleLog("** [Error] putDeedInTable ** " + String(err));
      }
      else
      {
        var index = res[0];
        count = id;
        GetIPFSData(count, index);
      }
    });

  }
GetDeedCount();
    document.getElementById("sysinfo").innerHTML = "You Account ID is " + whoami() ;
    </script>
    </form>

    <form action="/">
      <fieldset>
        <legend>Create Deed</legend>
        <input type="file" name="photo" id="photo">
        <button type="button" onclick="upload()">Upload</button>
        <input style="width: 600px;" type="text"  id="ipfsAddress">
        <button type="button" onclick="makeDeed(12345)">Create NFT Deed</button>
      </fieldset>
    </form>


      <fieldset>
        <legend>Your Deeds</legend>
          <button type="button" onclick="GetDeedCount()">Update</button>

        <div id="box">
      </div>

  <div id="deedbox">
  </div>

    <script type="text/javascript" >

    function consoleLog(thisString)
    {
      console.log(thisString);
      var oldcontent = document.getElementById("console").innerHTML;
      var html = thisString + "<br>" + oldcontent;
      document.getElementById("console").innerHTML = html;
    }
    function myGetCount()
    {
    //  consoleLog("GetCount");
    }
    function myTest()
    {
      myGetCount()
      var contract = EthereumConnection.GetContract("IPFS");

      contract.GetMintPrice(function(err, res){
        if (err)
        {
            document.getElementById("testbutton").innerHTML = "Not Connected to Ethereum Error!";
        }
        else
        {
          price = Number(res[0]);
          if (price == 10000000000000000)
            document.getElementById("testbutton").innerHTML = "OK!";
            else {
              document.getElementById("testbutton").innerHTML = "C Error!";
            }
        }
      });
    }

    </script>
      </fieldset>


    </br>
    </br>
    <a id="url"></a>
    </br>
    </br>
      <fieldset>
      <legend>Log</legend>
      </div>
      <div id="console">
      </fieldset>
    <img id="output">
  </body>
</html>
